<div class="container py-4">
  <h2 class="mb-4">Administration</h2>

  @if (feedback) {
  <div class="alert alert-success">{{ feedback }}</div>
  }
  @if (error) {
  <div class="alert alert-danger">{{ error }}</div>
  }

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Utilisateurs</h5>
        <small class="text-muted">{{ users.length }} éléments</small>
      </div>
      @if (loading) {
      <app-loading-spinner label="Chargement des données..."></app-loading-spinner>
      } @else {
      @if (editingUser) {
      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="border rounded p-3 mb-3 bg-light">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Nom</label>
            <input type="text" class="form-control" formControlName="displayName" />
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" formControlName="email" />
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label">Rôle</label>
            <select class="form-select" formControlName="role">
              <option value="USER">Utilisateur</option>
              <option value="ADMIN">Admin</option>
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label d-block">Bloqué</label>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" formControlName="blocked" id="blockedUser" />
              <label class="form-check-label" for="blockedUser">Compte bloqué</label>
            </div>
          </div>
          <div class="col-12 col-md-1 d-grid gap-2">
            <button
              type="submit"
              class="btn btn-primary btn-sm"
              [disabled]="userForm.invalid || userSubmitting"
            >
              {{ userSubmitting ? '...' : 'OK' }}
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelEditUser()">
              Annuler
            </button>
          </div>
        </div>
      </form>
      }
      @if (users.length) {
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Statut</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.id) {
          <tr>
            <td>{{ user.displayName }}</td>
            <td>{{ user.email }}</td>
            <td>
              <span class="badge" [class.text-bg-primary]="user.role === 'ADMIN'" [class.text-bg-secondary]="user.role === 'USER'">
                {{ user.role }}
              </span>
            </td>
            <td>
              @if (user.blockedAt) {
              <span class="badge text-bg-danger">Bloqué</span>
              } @else {
              <span class="badge text-bg-success">Actif</span>
              }
            </td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary me-2" (click)="startEditUser(user)">Modifier</button>
              <button class="btn btn-sm btn-outline-danger" (click)="confirmDeleteUser(user)">Supprimer</button>
            </td>
          </tr>
          }
        </tbody>
      </table>
      } @else {
      <p class="text-muted mb-0">Aucun utilisateur à afficher.</p>
      }
      }
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Recettes</h5>
        <small class="text-muted">{{ recipes.length }} éléments</small>
      </div>
      @if (loading) {
      <app-loading-spinner label="Chargement des données..."></app-loading-spinner>
      } @else {
      @if (recipes.length) {
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Catégorie</th>
            <th>Note</th>
            <th>Statut</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (recipe of recipes; track recipe.id) {
          <tr>
            <td>{{ recipe.title }}</td>
            <td>{{ recipe.category || 'Sans catégorie' }}</td>
            <td>★ {{ recipe.rating | number : '1.1-1' }}</td>
            <td>
              @if (recipe.hiddenAt) {
              <span class="badge text-bg-warning">Masquée</span>
              } @else {
              <span class="badge text-bg-success">Visible</span>
              }
            </td>
            <td class="text-end">
              <button
                class="btn btn-sm btn-outline-secondary me-2"
                (click)="toggleVisibility(recipe)"
              >
                {{ recipe.hiddenAt ? 'Réactiver' : 'Masquer' }}
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="confirmDeleteRecipe(recipe)">Supprimer</button>
            </td>
          </tr>
          }
        </tbody>
      </table>
      } @else {
      <p class="text-muted mb-0">Aucune recette à afficher.</p>
      }
      }
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Commentaires</h5>
        <small class="text-muted">{{ comments.length }} éléments</small>
      </div>
      @if (loading) {
      <app-loading-spinner label="Chargement des données..."></app-loading-spinner>
      } @else {
      @if (comments.length) {
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Recette</th>
            <th>Auteur</th>
            <th>Message</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (comment of comments; track comment.id) {
          <tr>
            <td>{{ comment.recipeTitle }}</td>
            <td>{{ comment.authorName }}</td>
            <td>{{ comment.message }}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-danger" (click)="confirmDeleteComment(comment)">Supprimer</button>
            </td>
          </tr>
          }
        </tbody>
      </table>
      } @else {
      <p class="text-muted mb-0">Aucun commentaire à modérer.</p>
      }
      }
    </div>
  </div>
</div>

<app-confirm-modal
  [open]="confirmOpen"
  [title]="confirmTitle"
  [message]="confirmMessage"
  (confirm)="handleConfirm()"
  (cancel)="handleCancel()"
></app-confirm-modal>
